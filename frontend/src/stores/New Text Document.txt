import { create } from 'zustand';
import { PDFDocument } from 'pdf-lib';
import toast from 'react-hot-toast';

export interface PDFDocumentState {
  id: string;
  name: string;
  pdfDoc: PDFDocument;
  arrayBuffer: ArrayBuffer;
  pageCount: number;
  currentPage: number;
}

interface DocumentsStore {
  documents: PDFDocumentState[];
  activeDocId: string | null;
  addDocument: (doc: PDFDocumentState) => void;
  removeDocument: (id: string) => void;
  updateDocument: (id: string, updates: Partial<PDFDocumentState>) => void;
  setActiveDocument: (id: string) => void;
  saveDocument: (id: string, saveAs: boolean) => Promise<void>;
}

function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

export const useDocumentsStore = create<DocumentsStore>((set, get) => ({
  documents: [],
  activeDocId: null,

  addDocument: (doc) => {
    set((state) => ({
      documents: [...state.documents, doc],
      activeDocId: doc.id,
    }));
  },

  removeDocument: (id) => {
    set((state) => {
      const newDocs = state.documents.filter((d) => d.id !== id);
      const newActiveId =
        state.activeDocId === id
          ? newDocs.length > 0
            ? newDocs[0].id
            : null
          : state.activeDocId;

      return {
        documents: newDocs,
        activeDocId: newActiveId,
      };
    });
  },

  updateDocument: (id, updates) => {
    set((state) => ({
      documents: state.documents.map((doc) =>
        doc.id === id ? { ...doc, ...updates } : doc
      ),
    }));
  },

  setActiveDocument: (id) => {
    set({ activeDocId: id });
  },

  saveDocument: async (id, saveAs) => {
    const doc = get().documents.find((d) => d.id === id);
    if (!doc) {
      toast.error('Document not found');
      return;
    }

    try {
      const pdfBytes = await doc.pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const filename = saveAs ? `${doc.name.replace('.pdf', '')}-edited.pdf` : doc.name;
      downloadBlob(blob, filename);
      toast.success('Document saved successfully');
    } catch (error) {
      console.error('Failed to save document:', error);
      toast.error('Failed to save document');
      throw error;
    }
  },
}));
